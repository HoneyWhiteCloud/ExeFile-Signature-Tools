# 数字签名生成/签名程序（非认证）

一个 Windows 数字签名生成和签名工具，帮助您创建自签名证书并为可执行文件签名。

本版为“全新 UI”版本，显著提升了易用性与稳定性，支持多语言、拖放、批量处理、Unicode 文件名、无控制台干扰等。

## 本版新增（全新 UI）

- 多语言自动识别与标题本地化：自动根据系统显示语言在简体中文/繁体中文/英文间切换，同时应用程序标题也随语言变化
- 高 DPI 适配：在高分屏上自动缩放，界面清晰
- 拖拽添加文件：支持将文件直接拖入列表（可选依赖 tkinterdnd2）
- 完全隐藏控制台窗口：签名/校验时不再闪出 cmd 窗口，体验更干净
- GUI 密码提示与缓存：PFX 需要密码时由 GUI 弹窗获取，记住同一 PFX 的密码，支持在打包为无控制台的 EXE 时正常签名
- Unicode 路径完全支持：含中文、全角括号等字符的文件/路径均能稳定签名与时间戳
- RFC 3161 时间戳优先：签名与补时间戳时优先使用 /tr + /td sha256，失败时自动回退 /t
- 批量与并发优化：
  - “验证签名”与“签名（不加时间戳）”支持多线程并发，性能更好
  - “签名并加时间戳”与“仅添加时间戳”为串行执行，避免时间戳服务器限流
- 友好的颜色日志与统计：验证结果按颜色分类汇总，关键信息清晰可读
- 图标加载更稳：兼容 PyInstaller 的资源路径，确保 ICO 图标正确显示

## 功能特性

- 一键生成证书并签名：生成 .pfx 并为程序签名 + 添加时间戳
- 使用现有证书签名：使用您现有的 .pfx 文件为程序签名
- 时间戳管理：为已签名文件添加时间戳，支持多个时间戳服务器（优先 RFC 3161）
- 多格式支持：.exe, .dll, .sys, .msi, .cab, .cat, .ocx, .ps1, .psm1, .psd1, .js, .vbs, .wsf
- 批量处理：批量签名或验证多个文件，支持并发
- 签名验证：颜色标识状态
  - 🟢 受信任的签名（权威机构认证）
  - 🟡 自签名证书（未经认证）
  - 🔴 未签名或签名无效
- 证书管理：生成 .pfx 与 .cer 证书

## 系统要求

- Windows 操作系统
- Python 3.10 或更高版本（如仅使用打包后的 EXE，最终用户无需安装 Python）
- 管理员权限（建议用于签名操作）
- 可选：tkinterdnd2（启用拖拽）
  - 安装：pip install tkinterdnd2

## 必需工具

以下工具必须存在于 `tools` 文件夹中：
- cert2spc.exe - 证书转 SPC 转换器
- makecert.exe - 证书创建工具
- pvk2pfx.exe - 私钥转 PFX 转换器
- signtool.exe - 微软签名工具

这些工具属于 Windows SDK，可从微软官网下载。

## 安装与运行

- 源码运行
  1. 克隆或下载仓库
  2. 确保 `tools` 文件夹内包含上述必需工具
  3. 可选安装拖拽支持：`pip install tkinterdnd2`
  4. 运行 GUI：
     ```bash
     python gui.py
     ```

- 打包为单文件 EXE（推荐给最终用户）
  - 已提供 PyInstaller 配置，直接在 `tool.spec` 所在目录执行：
    ```bash
    pyinstaller tool.spec
    ```
  - 提示
    - `tool.spec` 已包含资源文件（如 `icon.ico`、`tools` 目录）的打包设置
    - 建议使用 `console=False`（无控制台），本版已在内部屏蔽 signtool 弹窗并通过 GUI 处理密码

## 使用指南

1. 添加文件
   - 点击“添加文件”或直接将文件拖拽到列表（需安装 tkinterdnd2）
2. 选择证书
   - 使用现有 `.pfx`：在“证书与时间戳”区域选择 PFX 文件并输入密码（若留空，将在签名时弹窗提示）
   - 或点击“创建自签名 PFX…”一键生成（同时提供“仅创建 .cer”）
3. 选择时间戳服务器
   - 下拉选择常用服务器；签名时优先 `/tr`（RFC 3161），回退 `/t`
4. 选择操作
   - 验证签名：并发校验，日志展示状态与统计
   - 签名并加时间戳：串行执行，避免 TSA 限流
   - 签名（不加时间戳）：并发执行，速度更快
   - 仅添加时间戳：对已签名文件串行补时间戳
5. 查看日志
   - 彩色日志 + 统计摘要，关键字段包括签名者、颁发者与时间戳

## 常见问题

- 文件名包含中文或全角符号导致签名/时间戳失败？
  - 已修复：内部使用宽字符 API（无 shell）直接调用 signtool，完全支持 Unicode 路径
- 签名/验证时有 cmd 窗口一闪而过？
  - 已修复：启动子进程时隐藏窗口（CREATE_NO_WINDOW + SW_HIDE）
- 打包为无控制台（`console=False`）后无法输入 PFX 密码？
  - 已修复：GUI 会弹窗提示密码并缓存，确保无控制台场景也可正常签名
- 程序图标不显示或不清晰？
  - 请确保 `icon.ico` 内含 16×16、32×32（建议再加 48、64、256）等常见尺寸
- 拖拽无效？
  - 安装 tkinterdnd2 后重启程序：`pip install tkinterdnd2`
- 时间戳失败？
  - 可能是服务器限流或不稳定；本工具会优先 `/tr`（RFC 3161），失败回退 `/t`，可尝试更换 TSA

## 许可证

本项目用于学习与内部工具集成场景。请在遵守所在环境与证书合规要求的前提下使用。
